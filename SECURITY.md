# 🔒 项目安全说明

## 🛡️ 已实施的安全措施

### 1. Excel文件安全处理
为了缓解xlsx包的安全漏洞，我们实施了以下安全措施：

#### 安全封装模块 (`server/utils/excelSecurity.ts`)
- **文件大小限制**: 最大10MB
- **工作表限制**: 最多50个工作表  
- **数据量限制**: 最大100,000行，1,000列
- **文件类型验证**: 仅允许.xlsx、.xls、.csv
- **原型污染防护**: 清理对象属性，防止__proto__污染
- **禁用危险功能**: 禁用宏、公式解析、外部引用

#### 安全选项
```typescript
// 安全的Excel读取配置
{
  cellFormula: false,    // 不解析公式
  sheetStubs: false,     // 禁用工作表存根
  bookSST: false,        // 禁用共享字符串表
  compression: true      // 启用压缩
}
```

### 2. 用户认证和权限
- **JWT令牌认证**: 所有API请求需要有效令牌
- **密码加密**: 使用bcrypt加密用户密码
- **角色权限控制**: 基于角色的访问控制
- **请求限制**: 使用express-rate-limit防止暴力攻击

### 3. 输入验证和清理
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 输入数据清理和转义
- **文件上传安全**: 文件类型和大小验证
- **CORS配置**: 适当的跨域资源共享设置

### 4. 服务器安全
- **Helmet.js**: HTTP安全头设置
- **文件权限**: 上传文件权限控制
- **错误处理**: 不暴露敏感系统信息

## ⚠️ 已知安全风险

### 1. 依赖包漏洞

#### xlsx包 (高风险)
- **漏洞**: 原型污染 (GHSA-4r6h-8v6p-xvw6) 和 ReDoS (GHSA-5pgg-2g8v-p4x9)
- **影响**: 潜在的原型污染和正则表达式拒绝服务攻击
- **缓解措施**: 
  - ✅ 实施了安全封装模块
  - ✅ 添加了输入验证和清理
  - ✅ 禁用了危险功能
  - ✅ 限制了文件大小和复杂度

#### esbuild/vite (中等风险) 
- **漏洞**: 开发服务器跨域请求 (GHSA-67mh-4wv8-2f99)
- **影响**: 仅影响开发环境，生产环境无影响
- **缓解措施**: 
  - ✅ 生产环境不使用开发服务器
  - ✅ 开发环境仅本地访问

### 2. 推荐的安全实践

#### 生产环境部署
```bash
# 设置安全的环境变量
NODE_ENV=production
JWT_SECRET=<强密码-至少32字符>

# 使用HTTPS
ssl_certificate /path/to/cert.pem;
ssl_certificate_key /path/to/key.pem;

# 配置防火墙
ufw allow 80/tcp
ufw allow 443/tcp
ufw deny 3001/tcp  # 阻止直接访问API端口
```

#### 定期安全检查
```bash
# 检查依赖漏洞
npm audit
cd client && npm audit

# 更新依赖包
npm update
cd client && npm update
```

## 📋 安全检查清单

### 部署前检查
- [ ] 更新所有依赖包到最新版本
- [ ] 运行安全审计：`npm audit`
- [ ] 设置强JWT密钥
- [ ] 配置HTTPS证书
- [ ] 设置防火墙规则
- [ ] 禁用开发工具和调试模式
- [ ] 配置日志监控

### 运维监控
- [ ] 定期检查系统日志
- [ ] 监控异常登录尝试
- [ ] 检查文件上传情况
- [ ] 备份数据库
- [ ] 更新依赖包

## 🚨 安全事件响应

### 发现安全问题时
1. **立即隔离**: 断开网络连接
2. **评估影响**: 确定受影响范围
3. **修复漏洞**: 应用安全补丁
4. **数据检查**: 验证数据完整性
5. **加强监控**: 增加安全监控

### 联系方式
如发现安全漏洞，请立即联系系统管理员。

## 📚 安全资源

- [OWASP安全指南](https://owasp.org/www-project-top-ten/)
- [Node.js安全最佳实践](https://nodejs.org/en/docs/guides/security/)
- [npm安全审计](https://docs.npmjs.com/cli/v8/commands/npm-audit)

---

**最后更新**: 2024年6月2日  
**安全级别**: 中等风险 - 已实施缓解措施 